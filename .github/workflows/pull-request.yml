name: "pull-request"

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

env:
  ADMIN_EMAIL: $ADMIN_EMAIL_REMOTE
  ADMIN_PASSWORD: $ADMIN_PASSWORD_REMOTE
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  CONTENT_CE_DIST_PATH: "./dist/content-ce"
  APP_CONFIG_PROVIDER: ECM
  APP_CONFIG_AUTH_TYPE: BASIC
  APP_CONFIG_OAUTH2_HOST: http://localhost:4200/auth/realms/alfresco
  PLAYWRIGHT_E2E_HOST: "http://localhost:4200"
  APP_CONFIG_OAUTH2_CLIENTID: alfresco
  APP_CONFIG_PLUGIN_AOS: true
  APP_CONFIG_PLUGIN_CONTENT_SERVICE: true
  APP_CONFIG_ENABLE_MOBILE_APP_SWITCH: true
  APP_CONFIG_SESSION_TIME_FOR_OPEN_APP_DIALOG_DISPLAY_IN_HOURS: "12"
  APP_CONFIG_OAUTH2_IMPLICIT_FLOW: true
  APP_CONFIG_OAUTH2_SILENT_LOGIN: true
  APP_CONFIG_OAUTH2_REDIRECT_LOGOUT: /
  APP_CONFIG_OAUTH2_REDIRECT_LOGIN: /
  APP_CONFIG_OAUTH2_REDIRECT_SILENT_IFRAME_URI: "{protocol}//{hostname}{:port}/assets/silent-refresh.html"

jobs:
  setup:
    name: 'setup'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

  lint:
    name: 'lint'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: node
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  build:
    needs: [setup]
    name: 'build'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - uses: Alfresco/alfresco-build-tools/.github/actions/get-commit-message@v1.35.0

      - name: node
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'npm'
      - uses: ./.github/actions/before-install
      - run: npm ci
      - run: npm run build $BUILD_OPTS
      - name: upload job artifact
        if: ${{ success() }}
        uses: ./.github/actions/upload-job-artifact
        with:
          artifact: $CONTENT_CE_DIST_PATH
          output: $S3_DBP_FOLDER/alfresco-content-app.tar.bz2

  unit-tests:
    needs: [lint, build]
    name: "Unit tests: ${{ matrix.unit-tests.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        unit-tests:
          - name: "aca-content"
          - name: "adf-office-services-ext"
          - name: "aca-shared"
          - name: "aca-folder-rules"
          - name: "aca-preview"
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: node
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'npm'
      - uses: ./.github/actions/before-install
      - run: npm ci
      - run: npm test ${{ matrix.unit-tests.name }} -- --browsers=ChromeHeadless --watch=false $TEST_OPTS

  e2es:
    needs: [lint, build, unit-tests]
    name: 'E2e test suites: ${{ matrix.e2e-suites.name }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        e2e-suites:
          - name: "authentication,listViews,navigation,application"
          - name: "search"
          - name: "viewer,infoDrawer,extensions"
          - name: "shareActions"
          - name: "pagination"
          - name: "actionsAvailableFilesFolders"
          - name: "actionsAvailableLibraries,actionsAvailableNewMenu"
          - name: "actionsAvailableSpecialPermissions"
          - name: "copyMoveActions"
          - name: "createActions"
          - name: "deleteActions"
          - name: "editActions,favoriteActions"
          - name: "libraryActions"
          - name: "uploadDownloadActions"
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: node
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'npm'
      - uses: ./.github/actions/before-install
      - run: npm ci
      - name: run
        shell: bash
        run: |
          ./scripts/ci/job_hooks/before_e2e.sh "$S3_DBP_FOLDER/alfresco-content-app.tar.bz2" "$CONTENT_CE_DIST_PATH" "-a"
          ./scripts/ci/jobs/affected-project-with.sh -target e2e -options "--suite=${{ matrix.e2e-suites.name }}"
          ./scripts/ci/job_hooks/after_e2e.sh

  e2es-playwright:
    needs: [lint, build, unit-tests]
    name: 'E2e test suites: Folder Rules - Playwright'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: node
        uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'npm'
      - uses: ./.github/actions/before-install
      - run: npm ci
      - name: run
        shell: bash
        run: |
          ./scripts/ci/job_hooks/before_e2e.sh "$S3_DBP_FOLDER/alfresco-content-app.tar.bz2" "$CONTENT_CE_DIST_PATH" "-a"
          ./scripts/ci/job_hooks/before-playwright.sh
          ./scripts/ci/jobs/affected-project-with.sh -target e2e -options "e2e/playwright/tests/folder-rules/playwright.config.ts" -test-runner playwright
          ./scripts/ci/job_hooks/after_e2e.sh
